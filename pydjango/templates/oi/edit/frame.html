{% extends "oi/base_view.html" %}

{% load credits %}

{% block title %}
Editing {{ object_name }} :: {{ object }}
{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css"
      href="{{ MEDIA_URL }}/css/gcd/{{ style|default:'default' }}.css"/>
<link rel="stylesheet" type="text/css"
      href="{{ MEDIA_URL }}/css/oi/{{ style|default:'default' }}.css"/>
<link rel="stylesheet" type="text/css"
      href="{{ MEDIA_URL }}/css/oi/{{ style|default:'default' }}/edit.css"/>
{% endblock %}

{% block view_body %}
<h1>Editing {{ object_name }} :: {{ object }}</h1>

<div class="edit">
<!-- TODO: Not sure this elaborate status message stuff is necessary. -->
{% if revision.deleted %}
<p>
  {% ifequal revision.state states.OPEN %}
    There is an error with this revision.  Please contact a GCD editor
    for assistance.
  {% endifequal %}
  {% ifequal revision.state states.PENDING %}
    This revision has been marked as deleted and submitted for approval.
    Undelete is not yet implemented.  If you want to cancel the deletion,
    please contact a GCD editor.
  {% endifequal %}
  {% ifequal revision.state states.REVIEWING %}
    This revision has been marked deleted and is being reviewed for approval
    by GCD editor
    <a href="mailto:{{ revision.approver.indexer.email }}">{{ revision.approver.indexer }}</a>.
  {% endifequal %}
  {% ifequal revision.state states.APPROVED %}
    This deletion has been approved.
    Undelete is not yet implemented- please contact a GCD editor if you
    believe the deletion was in error.
  {% endifequal %}
  {% ifequal revision.state states.DISCARDED %}
    This deletion has been discarded, which means that the assocaited
    record has <strong>not</strong> been deleted.  Please reserve the
    record again if you would like to make changes.
  {% endifequal %}
</p>
{% else %}
  {% ifequal revision.state states.OPEN %}
<form action="{{ object_url }}" method="POST">
{% include object_form_template %}
{% include 'oi/bits/comments.html' %}

    {% ifequal object_class "story" %}
<input type="submit" name="save" value="Save and continue editing"></input>
<input type="submit" name="save_return" value="Save and return to issue"></input>
<input type="submit" name="cancel_return"
       value="Return to issue without saving"></input>
    {% else %}
      {% ifequal object_class "issue" %}
<input type="submit" name="save" value="Save and continue editing"></input>
      {% endifequal %}
<input type="submit" name="submit" value="Submit changes for approval"></input>
<input type="submit" name="discard" value="Discard all changes"></input>
    {% endifequal %}
</form>
  {% else %}
    <p>
    {% ifequal revision.state states.BASELINE %}
      This revision is stored for future data migration, and is not intended
      to be user-visibile.  This is not the revision you are looking for.
      Move along :-)
    {% endifequal %}
    {% ifequal revision.state states.PENDING %}
      This change has been submitted for approval, but is not yet under review.
      {% ifequal revision.indexer user %}
        <form action="{{ object_url }}" method="POST">
          <input type="submit" name="retract" value="Retract change and edit further" />
          <label for="comments">Comments</label>
          <input type="textarea" name="comments">
        </form>
      {% endifequal %}
    {% endifequal %}
    {% ifequal revision.state states.REVIEWING %}
      This change has been submitted for approval, and is being reviewed by
      GCD editor
      <a href="mailto:{{ revision.approver.indexer.email }}">{{ revision.approver.indexer }}</a>.
    {% endifequal %}
    {% ifequal revision.state states.APPROVED %}
      This revision has been approved.  If you would like to make further
      changes, please reserve the record again.
    {% endifequal %}
    {% ifequal revision.state states.DISCARDED %}
      This revision has been discarded.  This means that the changes have
      <strong>not</strong> been applied to the original record.
      If you would like to make changes, please reserve the record again.
    {% endifequal %}
    </p>
  {% endifequal %}
{% endif %}
</div>

{% ifequal object_class "issue" %}
{% ifequal revision.state states.OPEN %}
{% ifequal revision.indexer user %}
<p>
<em>Coming soon: The ability to add, delete or re-order stories.</em>
</p>
<table class="story_list">
{% for story in revision.ordered_story_revisions %}
  <tr>
    <td>
      {{ story.sequence_number }}.
      {{ story.title|default:'<span class="no_data">no title</span>' }}
      ({{ story.feature|default:'<span class="no_data">no feature</span>' }})
      {{ story.type }}, {{ story|show_page_count }}p
    </td>
    <td>{{ story|show_credit_status }}</td>
    <td>
      <form style="display:inline;" method="GET"
            action="{% url edit_revision model_name='story',id=story.id %}">
        <input type="submit" id="edit_{{ story.id }}" name="edit_{{ story.id }}"
               value="Edit">
        </input>
      </form>
    </td>
  </li>
{% endfor %}
</table>
{% endifequal %}
{% endifequal %}
{% endifequal %}

{% ifnotequal object_class "story" %}
<p>
<a href="{% url compare_revision model_name=object_class,id=revision.id %}"
   target="_blank">Compare changes to original</a> (opens in new window)
</p>
<p>
<a href="{% url preview_revision model_name=object_class,id=revision.id %}"
   target="_blank">Preview changes</a> (opens in new window)
</p>
{% endifnotequal %}

{% endblock %}
